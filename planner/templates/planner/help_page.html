{% extends 'planner/_base.html' %}

{% block title %}Comprehensive User Manual{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-6" x-data="{ activeSection: 'intro' }">
    <div class="flex flex-col lg:flex-row gap-8">
        
        <aside class="lg:w-1/5 shrink-0">
            <div class="glass rounded-xl shadow-lg p-4 sticky top-24 border border-white/20 max-h-[85vh] overflow-y-auto custom-scrollbar">
                <h3 class="font-bold text-gray-800 mb-4 px-2 text-lg border-b pb-2">User Manual</h3>
                
                <nav class="space-y-1 text-sm">
                    <p class="px-2 text-xs font-bold text-gray-400 uppercase mt-4 mb-2">Getting Started</p>
                    <a href="#intro" @click="activeSection = 'intro'" 
                       :class="activeSection === 'intro' ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                       class="block px-3 py-2 rounded transition-colors">1. Core Concepts</a>
                    
                    <p class="px-2 text-xs font-bold text-gray-400 uppercase mt-4 mb-2">Setup & Admin</p>
                    <a href="#config-general" @click="activeSection = 'config-general'"
                       :class="activeSection === 'config-general' ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                       class="block px-3 py-2 rounded transition-colors">2. Configuration</a>
                    <a href="#workforce" @click="activeSection = 'workforce'"
                       :class="activeSection === 'workforce' ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                       class="block px-3 py-2 rounded transition-colors">3. Workforce & Leaves</a>

                    <p class="px-2 text-xs font-bold text-gray-400 uppercase mt-4 mb-2">Execution</p>
                    <a href="#project-list" @click="activeSection = 'project-list'"
                       :class="activeSection === 'project-list' ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                       class="block px-3 py-2 rounded transition-colors">4. Project Management</a>
                    <a href="#activity-planner" @click="activeSection = 'activity-planner'"
                       :class="activeSection === 'activity-planner' ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                       class="block px-3 py-2 rounded transition-colors">5. The Gantt Chart</a>
                    
                    <p class="px-2 text-xs font-bold text-gray-400 uppercase mt-4 mb-2">Planning</p>
                    <a href="#sales-forecast" @click="activeSection = 'sales-forecast'"
                       :class="activeSection === 'sales-forecast' ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                       class="block px-3 py-2 rounded transition-colors">6. Sales Forecast</a>
                    <a href="#capacity-report" @click="activeSection = 'capacity-report'"
                       :class="activeSection === 'capacity-report' ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                       class="block px-3 py-2 rounded transition-colors">7. Capacity Report</a>
                </nav>
            </div>
        </aside>

        <main class="lg:w-4/5 space-y-12 pb-24">

            <section id="intro" class="scroll-mt-24">
                <div class="glass rounded-xl shadow-lg p-8 border border-white/20">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">1. Core Concepts & Logic</h1>
                    <p class="text-gray-600 mb-6 text-lg">
                        The Capacity Planner is a decision-support tool that calculates resource sufficiency. 
                        It answers: <em>"Do I have enough staff to survive the busiest week of the month?"</em>
                    </p>

                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6">
                        <h3 class="font-bold text-indigo-800 mb-2">The "Weekly Max" Calculation Engine</h3>
                        <p class="text-sm text-gray-700 mb-4">
                            Unlike Excel sheets that average hours over a month, this system breaks every month into weeks.
                        </p>
                        <div class="grid md:grid-cols-3 gap-4 text-center">
                            <div class="bg-white p-4 rounded shadow-sm">
                                <div class="text-xs text-gray-500 uppercase font-bold">Step 1</div>
                                <div class="font-bold text-gray-800 mt-1">Daily Scan</div>
                                <p class="text-xs text-gray-500 mt-2">System iterates through every single date (Mon-Sun) to find active tasks.</p>
                            </div>
                            <div class="bg-white p-4 rounded shadow-sm">
                                <div class="text-xs text-gray-500 uppercase font-bold">Step 2</div>
                                <div class="font-bold text-gray-800 mt-1">Weekly Bucket</div>
                                <p class="text-xs text-gray-500 mt-2">Sums up demand for Week 1, Week 2, Week 3, Week 4 individually.</p>
                            </div>
                            <div class="bg-white p-4 rounded shadow-sm ring-2 ring-indigo-500">
                                <div class="text-xs text-indigo-500 uppercase font-bold">Step 3</div>
                                <div class="font-bold text-indigo-700 mt-1">Peak Detection</div>
                                <p class="text-xs text-gray-500 mt-2">The <strong>Highest</strong> weekly requirement becomes the requirement for the whole month.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="config-general" class="scroll-mt-24">
                <div class="glass rounded-xl shadow-lg p-8 border border-white/20">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">2. Configuration (Admin)</h2>
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Global Settings</span>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-700 mb-3 border-l-4 border-blue-500 pl-3">A. General Settings Form</h3>
                        <table class="w-full text-sm border rounded-lg overflow-hidden">
                            <thead class="bg-gray-50 text-gray-700 font-bold">
                                <tr>
                                    <th class="px-4 py-3 border-b">Field</th>
                                    <th class="px-4 py-3 border-b">Data Type</th>
                                    <th class="px-4 py-3 border-b">Detailed Impact</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white hover:bg-gray-50">
                                    <td class="px-4 py-3 border-b font-mono text-blue-600">Working Hours Per Day</td>
                                    <td class="px-4 py-3 border-b">Float (e.g., 8.0)</td>
                                    <td class="px-4 py-3 border-b">
                                        The fundamental multiplier. <br>
                                        • Used to convert <strong>Activity Duration (Days)</strong> into <strong>Hours</strong>.<br>
                                        • Used to calculate <strong>Supply</strong> (e.g., 20 days * 8 hours = 160 capacity).
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-700 mb-3 border-l-4 border-purple-500 pl-3">B. Capacity Settings (Efficiency)</h3>
                        <p class="text-sm text-gray-600 mb-3">These settings are defined per Designation (Engineer, Team Lead, Manager).</p>
                        <table class="w-full text-sm border rounded-lg overflow-hidden">
                            <thead class="bg-gray-50 text-gray-700 font-bold">
                                <tr>
                                    <th class="px-4 py-3 border-b">Field</th>
                                    <th class="px-4 py-3 border-b">Detailed Impact</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white hover:bg-gray-50">
                                    <td class="px-4 py-3 border-b font-mono text-blue-600">Monthly Meeting Hours</td>
                                    <td class="px-4 py-3 border-b">
                                        <strong>Deduction.</strong> Subtracted directly from the gross monthly capacity.<br>
                                        <em>Example:</em> If set to 4.0, every Engineer has 4 hours less per month available for projects.
                                    </td>
                                </tr>
                                <tr class="bg-white hover:bg-gray-50">
                                    <td class="px-4 py-3 border-b font-mono text-blue-600">Monthly Leave Hours</td>
                                    <td class="px-4 py-3 border-b">
                                        <strong>Deduction.</strong> A buffer for "Unknown" leaves (sick days). <br>
                                        Does NOT replace the specific "Leaves" calendar. This is just a statistical buffer.
                                    </td>
                                </tr>
                                <tr class="bg-white hover:bg-gray-50">
                                    <td class="px-4 py-3 border-b font-mono text-blue-600">Efficiency Loss Factor (%)</td>
                                    <td class="px-4 py-3 border-b">
                                        <strong>Multiplier.</strong> <br>
                                        Formula: <code>Net = Gross * (1 - (Efficiency/100))</code>.<br>
                                        If set to 20%, an 8-hour day counts as only 6.4 productive hours.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-700 mb-3 border-l-4 border-green-500 pl-3">C. Project Types & Brackets</h3>
                        <p class="text-sm text-gray-600 mb-3">This controls the "Sales Forecast" auto-calculation logic.</p>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded border">
                                <h4 class="font-bold text-gray-800 text-sm mb-2">Project Type Fields</h4>
                                <ul class="text-xs text-gray-700 space-y-2">
                                    <li><strong>Segment/Category:</strong> Keys used to match imported Excel rows.</li>
                                    <li><strong>Involvement %:</strong> How much of the total project duration requires this role?
                                        <br><span class="text-gray-500">Ex: 20% means for a 10-day project, we need 2 days of effort from this role.</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="bg-gray-50 p-4 rounded border">
                                <h4 class="font-bold text-gray-800 text-sm mb-2">Effort Brackets (Interpolation)</h4>
                                <ul class="text-xs text-gray-700 space-y-2">
                                    <li><strong>Project Value (₹):</strong> The monetary size of a deal.</li>
                                    <li><strong>Effort Days:</strong> The estimated man-days required.</li>
                                    <li><strong>Logic:</strong> If a deal value falls between two brackets, the system calculates the effort mathematically (Linear Interpolation).</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="workforce" class="scroll-mt-24">
                <div class="glass rounded-xl shadow-lg p-8 border border-white/20">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">3. Workforce & Leaves</h2>
                    
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">Adding a Team Member</h3>
                            <div class="bg-white border rounded p-4">
                                <div class="mb-3">
                                    <span class="text-xs font-bold text-gray-500 uppercase">Field: Name</span>
                                    <p class="text-sm">Unique identifier. Creating a duplicate name will trigger an error.</p>
                                </div>
                                <div class="mb-3">
                                    <span class="text-xs font-bold text-gray-500 uppercase">Field: Designation</span>
                                    <p class="text-sm">Crucial. Determines which "Supply Pool" they belong to (Engineer, Lead, Manager).</p>
                                </div>
                                <div>
                                    <span class="text-xs font-bold text-gray-500 uppercase">Field: Is Active</span>
                                    <p class="text-sm">
                                        <span class="text-green-600 font-bold">True:</span> Counted in capacity.<br>
                                        <span class="text-red-600 font-bold">False:</span> Ignored. Use for past employees to preserve historical data without affecting future plans.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">Adding a Leave</h3>
                            <div class="bg-white border rounded p-4">
                                <p class="text-sm text-gray-600 mb-3">Leaves are specific dates where an employee contributes <strong>0 hours</strong>.</p>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                    <li><strong>Start/End Date:</strong> Inclusive range.</li>
                                    <li><strong>Impact:</strong> 
                                        If John is on leave Mon-Wed (3 days):
                                        <br>1. His Weekly Capacity drops by (3 * 8hrs).
                                        <br>2. The "Available Hours" in the report drops.
                                        <br>3. This might turn the Variance <strong>Red</strong>.
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="project-list" class="scroll-mt-24">
                <div class="glass rounded-xl shadow-lg p-8 border border-white/20">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">4. Project Management</h2>
                    
                    <h3 class="font-bold text-gray-700 mb-3">The Project Form</h3>
                    <table class="w-full text-sm border rounded-lg overflow-hidden mb-6">
                        <thead class="bg-gray-50 text-gray-700 font-bold">
                            <tr>
                                <th class="px-4 py-3 border-b">Field</th>
                                <th class="px-4 py-3 border-b">Detail</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b">
                                <td class="px-4 py-3 font-mono text-blue-600">Project Code</td>
                                <td class="px-4 py-3">Must be unique (e.g., "AXXXX"). Used in URLs and Lookups.</td>
                            </tr>
                            <tr class="bg-white border-b">
                                <td class="px-4 py-3 font-mono text-blue-600">Customer Name</td>
                                <td class="px-4 py-3">Descriptive label.</td>
                            </tr>
                            <tr class="bg-white border-b">
                                <td class="px-4 py-3 font-mono text-blue-600">Team Lead</td>
                                <td class="px-4 py-3">
                                    Filters the dropdown to only show employees with designation 'TEAM_LEAD'.
                                    Used for filtering the dashboard.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="bg-amber-50 border border-amber-200 rounded p-3 text-sm text-amber-800">
                        <strong>Feature:</strong> Clicking the <span class="bg-indigo-600 text-white px-1 rounded text-xs">Plan</span> button takes you to the Activity Planner (Gantt) for that specific project.
                    </div>
                </div>
            </section>

            <section id="activity-planner" class="scroll-mt-24">
                <div class="glass rounded-xl shadow-lg p-8 border border-white/20">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">5. The Activity Planner (Gantt)</h2>
                        <span class="px-3 py-1 bg-green-100 text-green-700 text-xs rounded-full font-bold">Core Feature</span>
                    </div>

                    <p class="text-gray-600 mb-6">This is where demand is created. Every bar on this chart represents hours subtracted from your supply.</p>

                    <div class="grid lg:grid-cols-2 gap-8 mb-8">
                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">Add Activity Form</h3>
                            <ul class="space-y-3 text-sm">
                                <li class="bg-white p-3 rounded border shadow-sm">
                                    <span class="font-bold text-gray-800 block">Assignee</span>
                                    <span class="text-gray-600">Who does the work? If left blank ("Unassigned"), the demand is tracked separately and will appear as "Unassigned" in reports.</span>
                                </li>
                                <li class="bg-white p-3 rounded border shadow-sm">
                                    <span class="font-bold text-gray-800 block">Start Date</span>
                                    <span class="text-gray-600">The calendar date work begins.</span>
                                </li>
                                <li class="bg-white p-3 rounded border shadow-sm">
                                    <span class="font-bold text-gray-800 block">Duration (Days)</span>
                                    <span class="text-gray-600">
                                        <strong>CRITICAL:</strong> This is <em>Working Days</em>, not Calendar Days.
                                        <br>Inputting "5" means "5 Working Days".
                                    </span>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-700 mb-3">Smart Date Logic</h3>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 h-full">
                                <p class="text-sm text-blue-800 font-bold mb-2">How End Date is Calculated:</p>
                                <p class="text-xs text-blue-700 mb-4 font-mono">
                                    current_date = start_date<br>
                                    days_counted = 0<br>
                                    while days_counted < duration:<br>
                                    &nbsp;&nbsp;if current_date is not Weekend AND not Holiday:<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;days_counted += 1<br>
                                    &nbsp;&nbsp;current_date += 1
                                </p>
                                <p class="text-sm text-blue-800">
                                    <strong>Result:</strong> If you start a 3-day task on Friday:<br>
                                    • Fri: Work (Day 1)<br>
                                    • Sat: Skip<br>
                                    • Sun: Skip<br>
                                    • Mon: Work (Day 2)<br>
                                    • Tue: Work (Day 3) -> <strong>End Date</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sales-forecast" class="scroll-mt-24">
                <div class="glass rounded-xl shadow-lg p-8 border border-white/20">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">6. Sales Forecast & Import</h2>
                    
                    <p class="text-gray-600 mb-6">
                        This module generates "Shadow Demand" based on your sales pipeline. It converts money (₹) into estimated hours.
                    </p>

                    <h3 class="font-bold text-gray-700 mb-3">JSON Import Schema</h3>
                    <p class="text-sm text-gray-500 mb-3">Copy-paste this structure into the import box.</p>
                    
                    <div class="overflow-x-auto bg-gray-900 rounded-lg p-4 mb-6">
<pre class="text-xs text-green-400 font-mono">
[
  {
    "Opportunity": "Bank Alpha Upgrade",   // Unique Name
    "Segment": "Banking",                  // Must match a Configured Segment
    "Category": "Implementation",          // Must match a Configured Category
    "Total Amount": "75000",               // Deal Value (used for sizing)
    "Start Date": "2023-11-01",            // Expected Start
    "End Date": "2024-02-28",              // Expected End
    "Probability(%)": "80"                 // (Currently informational)
  }
]
</pre>
                    </div>

                    <h3 class="font-bold text-gray-700 mb-3">The Calculation Chain</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700 bg-white p-4 rounded border">
                        <li><strong>Match:</strong> System finds the Project Type via Segment + Category.</li>
                        <li><strong>Size:</strong> System uses "Total Amount" (₹75,000) to find the Effort Bracket.
                            <ul class="list-disc list-inside pl-6 text-gray-500 text-xs mt-1">
                                <li>Bracket A: ₹50k = 40 days</li>
                                <li>Bracket B: ₹100k = 80 days</li>
                                <li>Result: ₹75k = 60 days (Interpolated)</li>
                            </ul>
                        </li>
                        <li><strong>Spread:</strong> It calculates <code>Daily Effort = 60 days / Total Project Duration</code>.</li>
                        <li><strong>Assign:</strong> It applies the Project Type's "Involvement %" (e.g., Engineer 100%, Lead 20%) to create daily demand for each role.</li>
                    </ol>
                </div>
            </section>

            <section id="capacity-report" class="scroll-mt-24">
                <div class="glass rounded-xl shadow-lg p-8 border border-white/20">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">7. Capacity Plan Report</h2>
                    
                    <p class="text-gray-600 mb-6">
                        The final output. A matrix of <strong>Time Periods (Columns)</strong> vs <strong>Designations (Rows)</strong>.
                    </p>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border rounded-lg">
                            <thead class="bg-indigo-600 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left">Column</th>
                                    <th class="px-4 py-3 text-left">Formula / Source</th>
                                    <th class="px-4 py-3 text-left">Meaning</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white border-b">
                                    <td class="px-4 py-3 font-bold">Available HC</td>
                                    <td class="px-4 py-3">Count of "Active" employees with this designation.</td>
                                    <td class="px-4 py-3">How many bodies you have.</td>
                                </tr>
                                <tr class="bg-gray-50 border-b">
                                    <td class="px-4 py-3 font-bold">Available Hours</td>
                                    <td class="px-4 py-3">
                                        <code>(HC * Days * Hours) - Deductions - Efficiency</code>
                                    </td>
                                    <td class="px-4 py-3">The net productive hours available for project work.</td>
                                </tr>
                                <tr class="bg-white border-b">
                                    <td class="px-4 py-3 font-bold text-indigo-600">Required HC</td>
                                    <td class="px-4 py-3 font-mono text-xs">
                                        MAX(Weekly_Demand / Weekly_Capacity_Per_Person)
                                    </td>
                                    <td class="px-4 py-3">
                                        The headcount needed to safely handle the <strong>busiest week</strong> of this period.
                                    </td>
                                </tr>
                                <tr class="bg-gray-50 border-b">
                                    <td class="px-4 py-3 font-bold">Required Hours</td>
                                    <td class="px-4 py-3">
                                        <code>Required_HC * Monthly_Capacity_Per_Person</code>
                                    </td>
                                    <td class="px-4 py-3">
                                        Normalized demand. Used to make the Variance calculation comparable.
                                    </td>
                                </tr>
                                <tr class="bg-white border-b">
                                    <td class="px-4 py-3 font-bold">Variance</td>
                                    <td class="px-4 py-3"><code>Available_Hours - Required_Hours</code></td>
                                    <td class="px-4 py-3">
                                        <span class="text-green-600 font-bold">+ Positive:</span> Bench/Buffer available.<br>
                                        <span class="text-red-600 font-bold">- Negative:</span> Staffing shortage predicted.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 bg-amber-50 border border-amber-200 p-4 rounded-lg">
                        <h4 class="font-bold text-amber-800 text-sm flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            FAQ: Why is Variance negative even if Total Hours look fine?
                        </h4>
                        <p class="text-sm text-amber-900 mt-1">
                            Because of the <strong>Weekly Max</strong> logic. If you need 200 hours in Week 1, and 0 hours in Week 2, 3, 4:
                            <br>• The average demand is low (50 hrs/week).
                            <br>• But Week 1 requires 5 people.
                            <br>• The report calculates required headcount based on that Week 1 spike (5 people), likely causing a negative variance if you only have 3 people, even if they sit idle for the rest of the month.
                        </p>
                    </div>
                </div>
            </section>

        </main>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.05);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
    }
    .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
    }
    html {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}