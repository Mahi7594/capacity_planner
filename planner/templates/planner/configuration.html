{% extends 'planner/_base.html' %}
{% load static planner_extras %}

{% block title %}Configuration{% endblock %}

{% block content %}
<style>
    .config-section {
        transition: all 0.3s ease;
    }
    .config-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        transition: border-color 0.2s;
    }
    .form-input:focus {
        border-color: #4f46e5;
        outline: none;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .btn-primary {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    .btn-secondary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn-danger {
        color: #dc2626;
        font-weight: 500;
        cursor: pointer;
        transition: color 0.2s;
    }
    .btn-danger:hover {
        color: #991b1b;
    }
    .table-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
    }
    .sticky-header {
        position: sticky;
        top: 0;
        background-color: #f9fafb;
        z-index: 10;
    }
    .icon {
        width: 2rem;
        height: 2rem;
        margin-right: 0.75rem;
    }
</style>

<header class="bg-white shadow-md">
    <div class="max-w-screen-2xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="flex items-center">
            <svg class="icon text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">Application Configuration</h1>
        </div>
        <p class="mt-2 text-gray-600">Manage your application settings, workforce parameters, and project configurations</p>
    </div>
</header>

<div class="max-w-screen-2xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        
        <!-- General Settings Section -->
        <div class="config-section bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="section-header px-6 py-4">
                <div class="flex items-center">
                    <svg class="icon text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                    </svg>
                    <h2 class="text-xl font-bold text-white">General Settings</h2>
                </div>
                <p class="text-indigo-100 text-sm mt-1">Configure basic application parameters</p>
            </div>
            <form method="POST" class="p-6">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Standard Working Hours per Day
                    </label>
                    <input type="number" step="0.1" name="working_hours_per_day" 
                           value="{{ general_settings.working_hours_per_day }}" 
                           class="form-input" placeholder="e.g., 8.0">
                    <p class="text-sm text-gray-500 mt-1">This will be used for all capacity calculations</p>
                </div>
                <div class="text-right">
                    <button type="submit" name="update_general_settings" class="btn-primary">
                        Save General Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Capacity Settings Section -->
        <div class="config-section bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="section-header px-6 py-4">
                <div class="flex items-center">
                    <svg class="icon text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <h2 class="text-xl font-bold text-white">Workforce Capacity</h2>
                </div>
                <p class="text-indigo-100 text-sm mt-1">Set non-project time and efficiency factors</p>
            </div>
            <form method="POST" class="p-6">
                {% csrf_token %}
                <div class="space-y-6">
                    {% for value, display in designations %}
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></span>
                            {{ display }}
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="form-label text-sm">Monthly Meeting Hours</label>
                                <input type="number" step="0.1" 
                                       name="meeting_hours_{{ value }}" 
                                       value="{{ capacity_settings|get_item:value|get_attribute:'monthly_meeting_hours' }}" 
                                       class="form-input text-sm" placeholder="0">
                            </div>
                            <div>
                                <label class="form-label text-sm">Monthly Leave Hours</label>
                                <input type="number" step="0.1" 
                                       name="leave_hours_{{ value }}" 
                                       value="{{ capacity_settings|get_item:value|get_attribute:'monthly_leave_hours' }}" 
                                       class="form-input text-sm" placeholder="0">
                            </div>
                            <div>
                                <label class="form-label text-sm">Efficiency Loss (%)</label>
                                <input type="number" step="0.1" 
                                       name="efficiency_{{ value }}" 
                                       value="{{ capacity_settings|get_item:value|get_attribute:'efficiency_loss_factor' }}" 
                                       class="form-input text-sm" placeholder="0">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="text-right mt-6">
                    <button type="submit" name="update_general_settings" class="btn-primary">
                        Save Capacity Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Company Holidays Section -->
        <div class="config-section bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="section-header px-6 py-4">
                <div class="flex items-center">
                    <svg class="icon text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <h2 class="text-xl font-bold text-white">Company Holidays</h2>
                </div>
                <p class="text-indigo-100 text-sm mt-1">Manage official holidays and non-working days</p>
            </div>
            <div class="p-6">
                <!-- Add Holiday Form -->
                <form method="POST" class="border-b border-gray-200 pb-6 mb-6">
                    {% csrf_token %}
                    <h3 class="font-semibold text-gray-800 mb-4">Add New Holiday</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Holiday Date</label>
                            <input type="date" name="holiday_date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" name="description" class="form-input" 
                                   placeholder="e.g., Christmas Day" required>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="submit" name="add_holiday" class="btn-secondary">
                            Add Holiday
                        </button>
                    </div>
                </form>

                <!-- Holidays List -->
                <h3 class="font-semibold text-gray-800 mb-4">Upcoming Holidays</h3>
                <div class="table-container">
                    <table class="w-full">
                        <thead class="sticky-header">
                            <tr class="border-b">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Description</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for holiday in holidays %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium">{{ holiday.date|date:"M d, Y" }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">{{ holiday.description }}</td>
                                <td class="px-4 py-3 text-sm">
                                    <form method="POST" action="{% url 'delete_holiday' holiday.pk %}" 
                                          onsubmit="return confirm('Delete this holiday?');" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                                    <svg class="w-12 h-12 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    No holidays added yet
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Project Types Section -->
        <div class="config-section bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="section-header px-6 py-4">
                <div class="flex items-center">
                    <svg class="icon text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <h2 class="text-xl font-bold text-white">Project Types & Benchmarks</h2>
                </div>
                <p class="text-indigo-100 text-sm mt-1">Define work categories and effort estimation</p>
            </div>
            <div class="p-6">
                <!-- Add Project Type Form -->
                <form method="POST" class="border-b border-gray-200 pb-6 mb-6">
                    {% csrf_token %}
                    <h3 class="font-semibold text-gray-800 mb-4">Add New Project Type</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="form-label">Segment</label>
                            <select name="segment" class="form-input" required>
                                <option value="">-- Select Segment --</option>
                                {% for segment in all_segments %}
                                <option value="{{ segment.pk }}">{{ segment.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select name="category" class="form-input" required>
                                <option value="">-- Select Category --</option>
                                {% for category in all_categories %}
                                <option value="{{ category.pk }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="form-group">
                            <label class="form-label">Engineer Involvement (%)</label>
                            <input type="number" step="0.1" name="engineer_involvement" 
                                   value="100" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Lead Involvement (%)</label>
                            <input type="number" step="0.1" name="team_lead_involvement" 
                                   value="30" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Manager Involvement (%)</label>
                            <input type="number" step="0.1" name="manager_involvement" 
                                   value="5" class="form-input" required>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="submit" name="add_project_type" class="btn-secondary">
                            Add Project Type
                        </button>
                    </div>
                </form>

                <!-- Project Types List -->
                <h3 class="font-semibold text-gray-800 mb-4">Existing Project Types</h3>
                <div class="table-container">
                    <table class="w-full">
                        <thead class="sticky-header">
                            <tr class="border-b">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Type</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Involvement</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for type in project_types %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium">
                                    <div class="flex items-center">
                                        <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
                                        {{ type.segment.name }} - {{ type.category.name }}
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-600">
                                    <div class="flex space-x-2 text-xs">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">E:{{ type.engineer_involvement }}%</span>
                                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded">TL:{{ type.team_lead_involvement }}%</span>
                                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">M:{{ type.manager_involvement }}%</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-sm space-x-2">
                                    <a href="{% url 'edit_project_type' type.pk %}" 
                                       class="text-indigo-600 hover:text-indigo-800 font-medium">Edit</a>
                                    <button class="manage-benchmarks-btn text-purple-600 hover:text-purple-800 font-medium" 
                                            data-type-id="{{ type.pk }}" data-type-name="{{ type }}">Benchmarks</button>
                                    <form method="POST" action="{% url 'delete_project_type' type.pk %}" 
                                          class="inline" onsubmit="return confirm('Delete this type?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                                    <svg class="w-12 h-12 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    No project types configured yet
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Benchmark Modal (keeping the existing modal code) -->
<div id="benchmarkModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <div>
                <h3 class="text-2xl font-semibold text-gray-800">Manage Benchmarks</h3>
                <p id="benchmarkModalTitle" class="text-sm text-gray-500"></p>
            </div>
            <button id="closeBenchmarkModal" type="button" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
        </div>
        <div class="mt-5">
            <div id="benchmarkTableContainer" class="mb-6" style="max-height: 250px; overflow-y: auto;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Project Value (in Cr)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Effort (Days)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                        </tr>
                    </thead>
                    <tbody id="benchmarkModalTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <form id="addBenchmarkForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end p-4 border rounded-md">
                <div class="md:col-span-2 grid grid-cols-2 gap-4">
                    <div>
                        <label for="new_project_value" class="block text-sm font-medium text-gray-700">Project Value (in Cr)</label>
                        <input type="number" step="any" id="new_project_value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="new_effort_days" class="block text-sm font-medium text-gray-700">Effort (Days)</label>
                        <input type="number" id="new_effort_days" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                </div>
                <div class="text-right"><button type="submit" class="bg-purple-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-purple-700">Add Benchmark</button></div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('benchmarkModal');
    const closeBtn = document.getElementById('closeBenchmarkModal');
    const modalTitle = document.getElementById('benchmarkModalTitle');
    const modalTableBody = document.getElementById('benchmarkModalTableBody');
    const addForm = document.getElementById('addBenchmarkForm');
    let currentProjectTypeId = null;

    const getCsrfToken = () => document.querySelector('form[method="POST"] input[name="csrfmiddlewaretoken"]').value;

    const openModal = (projectTypeId, projectTypeName) => {
        currentProjectTypeId = projectTypeId;
        modalTitle.textContent = `For Project Type: ${projectTypeName}`;
        modalTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Loading...</td></tr>';
        modal.classList.remove('hidden');

        fetch(`/api/project-type/${projectTypeId}/brackets/`)
            .then(response => response.json())
            .then(data => renderTable(data.brackets));
    };

    const closeModal = () => modal.classList.add('hidden');

    const renderTable = (brackets) => {
        modalTableBody.innerHTML = '';
        if (brackets.length === 0) {
            modalTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">No benchmarks configured.</td></tr>';
            return;
        }
        brackets.sort((a, b) => a.project_value - b.project_value).forEach(b => {
            modalTableBody.innerHTML += `
                <tr data-id="${b.id}">
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${b.project_value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${b.effort_days}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        <button class="delete-benchmark-btn text-red-600 hover:text-red-800" data-id="${b.id}">Delete</button>
                    </td>
                </tr>`;
        });
    };

    document.querySelectorAll('.manage-benchmarks-btn').forEach(btn => {
        btn.addEventListener('click', () => openModal(btn.dataset.typeId, btn.dataset.typeName));
    });

    addForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const valueInput = document.getElementById('new_project_value');
        const daysInput = document.getElementById('new_effort_days');
        
        fetch(`/api/project-type/${currentProjectTypeId}/add-bracket/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
            body: JSON.stringify({project_value: valueInput.value, effort_days: daysInput.value})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                fetch(`/api/project-type/${currentProjectTypeId}/brackets/`).then(res => res.json()).then(d => renderTable(d.brackets));
                addForm.reset();
            } else {
                alert(`Error: ${data.message}`);
            }
        });
    });

    modalTableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-benchmark-btn')) {
            const bracketId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this benchmark?')) {
                fetch(`/effort-bracket/${bracketId}/delete/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken() }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        e.target.closest('tr').remove();
                        if (modalTableBody.children.length === 0) {
                             modalTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">No benchmarks configured.</td></tr>';
                        }
                    }
                });
            }
        }
    });

    closeBtn.addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => {
        if (e.key === "Escape" && !modal.classList.contains('hidden')) closeModal();
    });
});
</script>
{% endblock %}